# Отчёт о тестровании, команда 2

## Unit-тесты

Запросы разделены на 2 домена - offers и orders, для каждого есть свои хендлеры и бизнес-логика. В тестах `offers_handler_test.go` и `orders_handler_test.go` проверяется полное взаимодействие с ручкой:
В `offers_handler_test.go`:
- Успешное создание оффера
- Невалидное тело запроса
- Отсутствие параметров
- Ответ в случае недоступности других сервисов

В `orders_handler_test.go`:
- Happy path
- Некорректное тело запроса
- Отсутвие параметров
- Использование несуществующего, устаревшего или уже использованного оффера
- Двойное завершение заказа

Также есть тесты `service_test.go` для `offers` и `orders`, которые более подробно разбирают разлиные случаи:

В `offers/service_test.go`:
- Получение уже существующего оффера
- Недоступность scooters - получаем internal error
- Недоступность zone - фолбек на кэш
- Расчёт стоимости поездки по конфигу и параметрам самоката, юзера и зоны

В `orders/service_test.go`:
- Happy path
- Создание уже существующего заказа (в такой ситуации он просто возвращается)
- Создание на несуществуюшем, истёкшем и использованном офере
- Некорректные параметры
- Поведение при недоступности критических сервисов

В `orders/servise_finish_test.go` тестируется завершение заказа:
- Успешное списание и разморозка
- Неудачная оплата
- Повторное завершение

В `storage/redis/cache_test.go` тесты на кеширование заказов и TTL кеша.


## Интеграционные тесты

В директории integration_tests на питоне были реализованы end-to-end тесты: они запускают систему через докер контейнер и делают реальные запросы. Проверяются такие сценарии:

- В `test_health.py` проверяется ответ на ручку `/health`

- В `test_api_contract.py` тестируются общие свойства ответов системы: схемы ответов ручек, уникальность id заказов, ответы при http коде не равном 200.

- В `test_offers.py` проверяется логика создания оффера при различных пользователях, самокатах и зонах.

- В `test_orders.py` подробно проверяются сценарии заказов:
  - Создание заказов: успешное создание, использование параметров оффера.
  - Получение заказа на разных стадиях жизни, проверка кеширования
  - Заверешние заказа
  - Полный цикл заказа

- В `test_concurrency.py` проверяются различные сценарии потенциальных гонок:   
  - создание нескольких оферов одного юзера на один самокат
  - создание нескольких заказов
  - одновременное заверешение заказа несколько раз
  - параллельный запуск нескольких поездок
  - одновременное завершение и создание заказа.

- В `test_degradation.py` проверяется поведение при недоступности нижележащих сервисов.

## Нагрузочное тестирование

Для проведения нагрузочного тестирование в сервисе external была сделана небольшая правка: запрос зоны / самоката / пользователя возвращает константный ответ.

Симулируется такой сценарий: пользователь создаёт оффер, создаёт на него заказ, сделает 100 операций get (в соответствии с условием) и завершает заказ. Симуляция работает в 50 потоков параллельно. Сервис был размещён в Yandex Cloud с 24 ​vCPU, запросы делались локально с ноутбука. По итогам замеров была получена производительность 18 запросов в секунду, что означает 18 RPS на создание заказа и 1800 RPS на получение заказа. Ожидаемо, мы не достигли нужного RPS, так как сервис, кеш и база имеют по одному инстансу, а также источник запросов являлся не слишком производительным.
